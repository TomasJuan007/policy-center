<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.tomasjuan007.policycenter.dal.mapper.TbRuleExtMapper">
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Jan 07 21:15:39 CST 2021.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>

    <update id="incrLftByExample" parameterType="map">
        update tb_rule
        <set>
            lft = lft+#{incr,jdbcType=BIGINT},
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause" />
        </if>
    </update>

    <update id="incrRgtByExample" parameterType="map">
        update tb_rule
        <set>
            rgt = rgt+#{incr,jdbcType=BIGINT},
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause" />
        </if>
    </update>

    <select id="selectNodesWithParentId" parameterType="com.github.tomasjuan007.policycenter.dal.model.TbRuleExample" resultType="com.github.tomasjuan007.policycenter.vo.nsm.RuleNode">
        select
            a.id,
            a.rule_id as ruleId,
            a.name,
            a.val,
            a.op,
            a.lft,
            a.rgt,
            a.lvl,
            b.id as pid
        from tb_rule a
        left join tb_rule b
        on b.rule_id = a.rule_id
        and b.lvl+1 = a.lvl
        <![CDATA[
          and b.lft < a.lft
          and b.rgt > a.rgt
        ]]>
        group by a.id
    </select>

    <select id="selectNodesBySubOrderReversal" parameterType="com.github.tomasjuan007.policycenter.dal.model.TbRuleExample" resultType="com.github.tomasjuan007.policycenter.vo.nsm.RuleNode">
        select
            a.id,
            a.rule_id as ruleId,
            a.name,
            a.val,
            a.op,
            a.lft,
            a.rgt,
            a.lvl,
            b.id as pid
        from tb_rule a
        left join tb_rule b
        on b.rule_id = a.rule_id
        and b.lvl+1 = a.lvl
        <![CDATA[
            and b.lft < a.lft
            and b.rgt > a.rgt
        ]]>
        group by a.id
        ORDER BY a.rgt desc
    </select>

    <select id="selectLeafNodesByPreOrderReversal" parameterType="com.github.tomasjuan007.policycenter.dal.model.TbRuleExample" resultType="com.github.tomasjuan007.policycenter.vo.nsm.RuleNode">
        select
            a.id,
            a.rule_id as ruleId,
            a.name,
            a.val,
            a.op,
            a.lft,
            a.rgt,
            a.lvl,
            b.id as pid
        from tb_rule a
        left join tb_rule b
        on b.rule_id = a.rule_id
        and b.lvl+1 = a.lvl
        <![CDATA[
            and b.lft < a.lft
            and b.rgt > a.rgt
        ]]>
        group by a.id
        HAVING (a.rgt-a.lft)=1
        ORDER BY a.lft desc
    </select>

    <insert id="insertPerformanceRecord"  parameterType="map">
        INSERT INTO `tb_rule` (`rule_id`, `app`, `name`, `val`, `op`, `lft`, `rgt`, `lvl`, `is_deleted`, `created_at`, `updated_at`)
        VALUES
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,35]', 'btw', 1, 26, 0, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 2, 9, 1, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,35]', 'btw', 10, 17, 1, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 18, 25, 1, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 3, 4, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 5, 6, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 7, 8, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 11, 12, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,35]', 'btw', 13, 14, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 15, 16, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 19, 20, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 21, 22, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10'),
        (#{ruleId,jdbcType=BIGINT}, '', 'age', '[18,25]', 'btw', 23, 24, 2, 0, '2021-01-15 19:49:10', '2021-01-15 19:49:10')
    </insert>
</mapper>